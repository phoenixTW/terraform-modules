name: Terraform CI

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

jobs:
  detect-changed-modules:
    name: Detect changed modules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed Terraform module directories
        id: detect
        run: |
          BASE_REF="${{ github.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            echo "No base_ref found; defaulting to origin/main"
            BASE_REF="origin/main"
          fi

          git fetch origin "$BASE_REF":"$BASE_REF" || true

          CHANGED_FILES=$(git diff --name-only "$BASE_REF"...HEAD -- '*.tf' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed .tf files detected."
            echo "modules=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MODULE_DIRS=$(echo "$CHANGED_FILES" | awk -F'/' 'NF>1 {print $1}' | sort -u)

          # Build a compact, single-line JSON array to satisfy GITHUB_OUTPUT format
          MODULES_JSON=$(printf '%s\n' "$MODULE_DIRS" | jq -R . | jq -s -c .)

          echo "Detected module directories: $MODULES_JSON"
          echo "modules=$MODULES_JSON" >> "$GITHUB_OUTPUT"

      - name: Set matrix
        id: set-matrix
        run: |
          MODULES='${{ steps.detect.outputs.modules }}'
          if [ -z "$MODULES" ] || [ "$MODULES" = "[]" ]; then
            echo "No modules to test; setting empty matrix."
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
          else
            echo "matrix={\"include\":$(echo "$MODULES" | jq '[.[] | {module: .}]')}" >> "$GITHUB_OUTPUT"
          fi

  terraform-checks:
    name: Terraform checks
    needs: detect-changed-modules
    if: needs.detect-changed-modules.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changed-modules.outputs.matrix) }}

    defaults:
      run:
        working-directory: ${{ matrix.module }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform fmt
        run: terraform fmt -check -recursive

      - name: Terraform init
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

      - name: Set up TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.53.0

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint

      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scanners: misconfig
          ignore-unfixed: true
          exit-code: '1'
          format: table
          severity: HIGH,CRITICAL

      - name: Run Trivy on module
        run: trivy fs --scanners misconfig .

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ matrix.module }}

